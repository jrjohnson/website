---
if (!process.env.GITHUB_TOKEN) {
  throw new Error('Error: Specify GITHUB_TOKEN in environment');
}

import { Octokit } from '@octokit/rest';
import { DateTime } from 'luxon';

type Day = {
  color: string;
  contributionCount: number;
  date: string;
};
type Week = {
  contributionDays: Day[];
};
type Weeks = Week[];
type GraphResponse = {
  user: {
    contributionsCollection: {
      contributionCalendar: {
        totalContributions: number,
        weeks: Weeks;
      };
    };
  };
};

const octokit = new Octokit({
  auth: process.env.GITHUB_TOKEN,
  userAgent: 'jrjohnson website build',
  request: {
    timeout: 5000,
  },
});

const query = `
  query($username: String!, $from: DateTime!) {
    user(login: $username) {
      name
      contributionsCollection(from: $from) {
        contributionCalendar {
          totalContributions
          colors
          weeks {
            contributionDays {
              color
              contributionCount
              date
            }
          }
        }
      }
    }
  }
`;

const from = DateTime.now().minus({ days: 364 }).toISO();
const response: GraphResponse = await octokit.graphql(query, { username: 'jrjohnson', from });

const { contributionsCollection: col } = response.user;
const days = col.contributionCalendar.weeks.reduce((days, { contributionDays }) => {
  contributionDays.forEach(d => days.push(d));

  return days;
}, [] as Day[]);

days.forEach(d => {
  const dt = DateTime.fromISO(d.date).toLocaleString(DateTime.DATE_FULL, { locale: 'en-us' });
  d.date = dt;
});

const { class: className, ...rest } = Astro.props;

---
<style>
  p {
    margin: 0.25rem;
    text-align: center;
  }
  .contribution-graph {
    display: grid;
    grid-template-rows: repeat(7, auto);
    grid-template-columns: repeat(53, 1fr);
    grid-auto-flow: column;
    gap: 0.1rem;

    div {
      border-radius: 0.1rem;
      aspect-ratio: 1 / 1;
    }
  }

</style>

<div class={className} {...rest}>
  <h3>Github Contributions</h3>
  <p>{col.contributionCalendar.totalContributions} contrubtions since {days[0].date}.</p>
  <div class="contribution-graph">
    {days.map(day => (
      <div style=`background-color: ${day.color}` title=`${day.contributionCount} contributions on ${day.date}`></div>
    ))}
  </div>
</div>
